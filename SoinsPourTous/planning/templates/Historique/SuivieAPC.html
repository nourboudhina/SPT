{% extends "Accueil/baseM.html" %}
{% load static %}
{% block title %} Suivie APC {% endblock title%}
{% block content %}

<head><!-- fullcalendar css -->
    <link href="{% static 'assets/libs/fullcalendar/main.min.css' %}" rel="stylesheet" type="text/css" />
    <!-- Layout config Js -->
    <script src="{% static 'assets/js/layout.js' %}"></script>
    <!-- Bootstrap Css -->
    <link href="{% static 'assets/css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="{% static 'assets/css/icons.min.css' %}" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="{% static 'assets/css/app.min.css' %}" rel="stylesheet" type="text/css" />
    <!-- custom Css-->
    <link href="{% static 'assets/css/custom.min.css' %}" rel="stylesheet" type="text/css" />


</head>

<div class="main-content">

    <div class="page-content">
        <div class="container-fluid">

            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">Suivie D'APC</h4>

                       
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row">
                <div class="col-12">
                    <div class="row">
                        <div class="col-xl-3">
                            <div class="card card-h-100">
                                        
                                <h5 class="mb-1">Total des Consultations par mois:</h5>
                                
                                <div class="pe-2 me-n1 mb-3" data-simplebar style="height: 400px">
                                    <div id="upcoming-event-list">
                                        <!-- api de "suivi_apc" qui affcihe le nombre total-->>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body bg-soft-info">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <i data-feather="calendar" class="text-info icon-dual-info"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="fs-15">Bienvenue!</h6>
                                            <p class="text-muted mb-0">Il est important de noter que votre suivi mensuel sera affiché ici.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!--end card-->
                        </div> <!-- end col-->

                        <div class="col-xl-9">
                            <div class="card card-h-100">
                                <div class="card-body">
                                    <div id="calendar"></div>
                                </div>
                            </div>
                        </div><!-- end col -->
                    </div>
                    <!--end row-->

                    <div style='clear:both'></div>

                    <div class="modal fade" id="event-modal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0">
                                <div class="modal-header p-3 bg-soft-info">
                                    <h5 class="modal-title" id="modal-title">Consultation</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <form class="needs-validation" name="event-form" id="form-event" novalidate>
                                       <!-- l'affichage mta3 détails de apc -->
                                        <div class="event-details">
                                            <div class="d-flex mb-2">
                                                <div class="flex-grow-1 d-flex align-items-center">
                                                    <div class="flex-shrink-0 me-3">
                                                        <i class="ri-calendar-event-line text-muted fs-16"></i>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="d-block fw-semibold mb-0" id="event-start-date-tag"></h6>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="flex-shrink-0 me-3">
                                                    <i class="ri-time-line text-muted fs-16"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="d-block fw-semibold mb-0"><span id="event-timepicker1-tag"></span> - <span id="event-timepicker2-tag"></span></h6>
                                                </div>
                                            </div>
                                            
                                        </div>
                                        
                                    </form>
                                </div>
                            </div> <!-- end modal-content-->
                        </div> <!-- end modal dialog-->
                    </div> <!-- end modal-->
                    <!-- end modal-->
                </div>
            </div> <!-- end row-->

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->
 
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const apcListElement = document.getElementById('upcoming-event-list');
            const pathArray = window.location.pathname.split('/');
            const token = pathArray[pathArray.length - 2]; // Assuming token is the last segment
        
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    fetch(`/planning/suivi_apc/${token}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ month: `${fetchInfo.startStr.split('-')[0]}-${fetchInfo.startStr.split('-')[1]}` })
                    })
                    .then(response => response.json())
                    .then(data => {
                        
                        const events = data.apc.map(apc => {
                            return {
                                title: `APC ID: ${apc.id}`,
                                start: apc.date,
                                allDay: true
                                
                            };
                        });
                        successCallback(events);
        
                        apcListElement.innerHTML = `<h5>Total des Consultations: ${data.total_patients}</h5>`;
                        data.apc.forEach(apc => {
                            apcListElement.innerHTML += `<div class='apc-item'><p>APC ID: ${apc.id}</p><p>Date: ${new Date(apc.date).toLocaleDateString()}</p></div>`;
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching APC data:', error);
                        failureCallback(error);
                        apcListElement.innerHTML = `<p>Error loading data. Please try again later.</p>`;
                    });
                }
            });
        
            calendar.render();
        });
        </script>
        
        
        
        
     <!-- JAVASCRIPT -->
    <link href="{% static 'assets/libs/fullcalendar/main.min.css' %}" rel="stylesheet" type="text/css" />
    <script src="{% static 'assets/libs/fullcalendar/main.min.js' %}"></script>

     <script src="{% static 'assets/libs/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
     <script src="{% static 'assets/libs/simplebar/simplebar.min.js' %}"></script>
     <script src="{% static 'assets/libs/node-waves/waves.min.js' %}"></script>
     <script src="{% static 'assets/libs/feather-icons/feather.min.js' %}"></script>
     <script src="{% static 'assets/js/pages/plugins/lord-icon-2.1.0.js' %}"></script>
     <script src="{% static 'assets/js/plugins.js' %}"></script>
 
     <!-- calendar min js -->
     <script src="{% static 'assets/libs/fullcalendar/main.min.js' %}"></script>
 
     <!-- Calendar init -->
     <script src="{% static 'assets/js/pages/calendar.init.js' %}"></script>
 
     <!-- App js -->
     <script src="{% static 'assets/js/app.js' %}"></script>

{% endblock content %}